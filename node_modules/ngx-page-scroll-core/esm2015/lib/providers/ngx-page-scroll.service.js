import { Inject, Injectable, isDevMode } from '@angular/core';
import { PageScrollInstance } from '../page-scroll-instance';
import { defaultPageScrollConfig, NGXPS_CONFIG } from './config.provider';
import * as i0 from "@angular/core";
import * as i1 from "./config.provider";
export class PageScrollService {
    constructor(customConfig) {
        this.runningInstances = [];
        this.onInterrupted = {
            report: (event, pageScrollInstance) => {
                if (!pageScrollInstance.pageScrollOptions.interruptible) {
                    // Non-interruptible anyway, so do not stop anything
                    return;
                }
                let shouldStop = true;
                if (event.type === 'keyup') {
                    // Only stop if specific keys have been pressed, for all others don't stop anything
                    if (this.config.interruptKeys.indexOf(event.key) === -1) {
                        // The pressed key is not in the list of interrupting keys
                        shouldStop = false;
                    }
                }
                else if (event.type === 'mousedown') {
                    // For mousedown events we only stop the scroll animation of the mouse has
                    // been clicked inside the scrolling container
                    if (!pageScrollInstance.pageScrollOptions.scrollViews.some(scrollingView => scrollingView.contains(event.target))) {
                        // Mouse clicked an element which is not inside any of the the scrolling containers
                        shouldStop = false;
                    }
                }
                if (shouldStop) {
                    this.stopAll(pageScrollInstance.pageScrollOptions.namespace);
                }
            },
        };
        this.config = Object.assign(Object.assign({}, defaultPageScrollConfig), customConfig);
        if (PageScrollService.instanceCounter > 0 &&
            (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode()))) {
            console.warn('An instance of PageScrollService already exists, usually ' +
                'including one provider should be enough, so double check.');
        }
        PageScrollService.instanceCounter++;
    }
    stopInternal(interrupted, pageScrollInstance) {
        const index = this.runningInstances.indexOf(pageScrollInstance);
        if (index >= 0) {
            this.runningInstances.splice(index, 1);
        }
        if (pageScrollInstance.interruptListenersAttached) {
            pageScrollInstance.detachInterruptListeners();
        }
        if (pageScrollInstance.timer) {
            // Clear/Stop the timer
            clearInterval(pageScrollInstance.timer);
            // Clear the reference to this timer
            pageScrollInstance.timer = undefined;
            pageScrollInstance.fireEvent(!interrupted);
            return true;
        }
        return false;
    }
    create(options) {
        return new PageScrollInstance(Object.assign(Object.assign({}, this.config), options));
    }
    /**
     * Start a scroll animation. All properties of the animation are stored in the given {@link PageScrollInstance} object.
     *
     * This is the core functionality of the whole library.
     */
    // tslint:disable-next-line:cyclomatic-complexity
    start(pageScrollInstance) {
        // Merge the default options in the pageScrollInstance options
        pageScrollInstance.pageScrollOptions = Object.assign(Object.assign({}, this.config), pageScrollInstance.pageScrollOptions);
        // Stop all possibly running scroll animations in the same namespace
        this.stopAll(pageScrollInstance.pageScrollOptions.namespace);
        if (pageScrollInstance.pageScrollOptions.scrollViews === null || pageScrollInstance.pageScrollOptions.scrollViews.length === 0) {
            // No scrollViews specified, thus we can't animate anything
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                console.warn('No scrollViews specified, thus ngx-page-scroll does not know which DOM elements to scroll');
            }
            return;
        }
        let startScrollPositionFound = false;
        let scrollRange = pageScrollInstance.getScrollClientPropertyValue(pageScrollInstance.pageScrollOptions.scrollViews[0]);
        // Reset start scroll position to 0. If any of the scrollViews has a different one, it will be extracted next
        pageScrollInstance.startScrollPosition = 0;
        // Get the start scroll position from the scrollViews (e.g. if the user already scrolled down the content)
        pageScrollInstance.pageScrollOptions.scrollViews.forEach(scrollingView => {
            if (scrollingView === undefined || scrollingView === null) {
                return;
            }
            // Get the scrollTop or scrollLeft value of the first scrollingView that returns a value for its "scrollTop"
            // or "scrollLeft" property that is not undefined and unequal to 0
            const scrollPosition = pageScrollInstance.getScrollPropertyValue(scrollingView);
            if (!startScrollPositionFound && scrollPosition) {
                // We found a scrollingView that does not have scrollTop or scrollLeft 0
                // Return the scroll position value, as this will be our startScrollPosition
                pageScrollInstance.startScrollPosition = scrollPosition;
                startScrollPositionFound = true;
                // Remember te scrollRange of this scrollingView
                scrollRange = pageScrollInstance.getScrollClientPropertyValue(scrollingView);
            }
        });
        const pageScrollOffset = pageScrollInstance.getCurrentOffset();
        // Calculate the target position that the scroll animation should go to
        const scrollTargetPosition = pageScrollInstance.extractScrollTargetPosition();
        pageScrollInstance.targetScrollPosition = Math.round((pageScrollInstance.pageScrollOptions.verticalScrolling ? scrollTargetPosition.top : scrollTargetPosition.left) - pageScrollOffset);
        // Calculate the distance we need to go in total
        pageScrollInstance.distanceToScroll = pageScrollInstance.targetScrollPosition - pageScrollInstance.startScrollPosition;
        if (isNaN(pageScrollInstance.distanceToScroll)) {
            // We weren't able to find the target position, maybe the element does not exist?
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                console.log('Scrolling not possible, as we can\'t find the specified target');
            }
            pageScrollInstance.fireEvent(false);
            return;
        }
        // We're at the final destination already
        // OR we need to scroll down but are already at the end
        // OR we need to scroll up but are at the top already
        const allReadyAtDestination = Math.abs(pageScrollInstance.distanceToScroll) < pageScrollInstance.pageScrollOptions._minScrollDistance;
        // Check how long we need to scroll if a speed option is given
        // Default executionDuration is the specified duration
        pageScrollInstance.executionDuration = pageScrollInstance.pageScrollOptions.duration;
        // Maybe we need to pay attention to the speed option?
        if ((pageScrollInstance.pageScrollOptions.speed !== undefined && pageScrollInstance.pageScrollOptions.speed !== null) &&
            (pageScrollInstance.pageScrollOptions.duration === undefined || pageScrollInstance.pageScrollOptions.duration === null)) {
            // Speed option is set and no duration => calculate duration based on speed and scroll distance
            pageScrollInstance.executionDuration =
                Math.abs(pageScrollInstance.distanceToScroll) / pageScrollInstance.pageScrollOptions.speed * 1000;
        }
        // We should go there directly, as our "animation" would have one big step
        // only anyway and this way we save the interval stuff
        const tooShortInterval = pageScrollInstance.executionDuration <= pageScrollInstance.pageScrollOptions._interval;
        if (allReadyAtDestination || tooShortInterval) {
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                if (allReadyAtDestination) {
                    console.log('Scrolling not possible, as we can\'t get any closer to the destination');
                }
                else {
                    console.log('Scroll duration shorter that interval length, jumping to target');
                }
            }
            pageScrollInstance.setScrollPosition(pageScrollInstance.targetScrollPosition);
            pageScrollInstance.fireEvent(true);
            return;
        }
        if (!pageScrollInstance.pageScrollOptions.scrollInView) {
            const alreadyInView = pageScrollInstance.targetScrollPosition > pageScrollInstance.startScrollPosition &&
                pageScrollInstance.targetScrollPosition <= pageScrollInstance.startScrollPosition + scrollRange;
            if (alreadyInView) {
                if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                    console.log('Not scrolling, as target already in view');
                }
                pageScrollInstance.fireEvent(true);
                return;
            }
        }
        // Register the interrupt listeners if we want an interruptible scroll animation
        if (pageScrollInstance.pageScrollOptions.interruptible) {
            pageScrollInstance.attachInterruptListeners(this.onInterrupted);
        }
        // Let's get started, get the start time...
        pageScrollInstance.startTime = new Date().getTime();
        // .. and calculate the end time (when we need to finish at last)
        pageScrollInstance.endTime = pageScrollInstance.startTime + pageScrollInstance.executionDuration;
        pageScrollInstance.timer = setInterval((instance) => {
            // Take the current time
            const currentTime = new Date().getTime();
            // Determine the new scroll position
            let newScrollPosition;
            let stopNow = false;
            if (instance.endTime <= currentTime) {
                // We're over the time already, so go the targetScrollPosition (aka destination)
                newScrollPosition = instance.targetScrollPosition;
                stopNow = true;
            }
            else {
                // Calculate the scroll position based on the current time using the easing function
                newScrollPosition = Math.round(instance.pageScrollOptions.easingLogic(currentTime - instance.startTime, instance.startScrollPosition, instance.distanceToScroll, instance.executionDuration));
            }
            if (this.config._logLevel >= 5 && isDevMode()) {
                console.warn('Scroll Position: ' + newScrollPosition);
            }
            // Set the new scrollPosition to all scrollViews elements
            if (!instance.setScrollPosition(newScrollPosition)) {
                // Setting the new scrollTop/scrollLeft value failed for all ScrollViews
                // early stop the scroll animation to save resources
                stopNow = true;
            }
            // At the end do the internal stop maintenance and fire the pageScrollFinish event
            // (otherwise the event might arrive at "too early")
            if (stopNow) {
                this.stopInternal(false, instance);
            }
        }, this.config._interval, pageScrollInstance);
        // Register the instance as running one
        this.runningInstances.push(pageScrollInstance);
    }
    scroll(options) {
        this.start(this.create(options));
    }
    /**
     * Stop all running scroll animations. Optionally limit to stop only the ones of specific namespace.
     */
    stopAll(namespace) {
        if (this.runningInstances.length > 0) {
            let stoppedSome = false;
            for (let i = 0; i < this.runningInstances.length; ++i) {
                const pageScrollInstance = this.runningInstances[i];
                if (!namespace || pageScrollInstance.pageScrollOptions.namespace === namespace) {
                    stoppedSome = true;
                    this.stopInternal(true, pageScrollInstance);
                    // Decrease the counter, as we removed an item from the array we iterate over
                    i--;
                }
            }
            return stoppedSome;
        }
        return false;
    }
    stop(pageScrollInstance) {
        return this.stopInternal(true, pageScrollInstance);
    }
}
PageScrollService.instanceCounter = 0;
PageScrollService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PageScrollService_Factory() { return new PageScrollService(i0.ɵɵinject(i1.NGXPS_CONFIG)); }, token: PageScrollService, providedIn: "root" });
PageScrollService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
PageScrollService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NGXPS_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBhZ2Utc2Nyb2xsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtcGFnZS1zY3JvbGwtY29yZS9zcmMvbGliL3Byb3ZpZGVycy9uZ3gtcGFnZS1zY3JvbGwuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHOUQsT0FBTyxFQUFxQixrQkFBa0IsRUFBcUIsTUFBTSx5QkFBeUIsQ0FBQztBQUNuRyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7OztBQUsxRSxNQUFNLE9BQU8saUJBQWlCO0lBdVE1QixZQUFrQyxZQUE4QjtRQWxReEQscUJBQWdCLEdBQXlCLEVBQUUsQ0FBQztRQUU1QyxrQkFBYSxHQUFzQjtZQUN6QyxNQUFNLEVBQUUsQ0FBQyxLQUFZLEVBQUUsa0JBQXNDLEVBQVEsRUFBRTtnQkFDckUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRTtvQkFDdkQsb0RBQW9EO29CQUNwRCxPQUFPO2lCQUNSO2dCQUVELElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztnQkFFdEIsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRTtvQkFDMUIsbUZBQW1GO29CQUNuRixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBRSxLQUF1QixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO3dCQUMxRSwwREFBMEQ7d0JBQzFELFVBQVUsR0FBRyxLQUFLLENBQUM7cUJBQ3BCO2lCQUNGO3FCQUFNLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7b0JBQ3JDLDBFQUEwRTtvQkFDMUUsOENBQThDO29CQUM5QyxJQUFJLENBQUMsa0JB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QUFJLENBQUMsU0FBUyxJQUFJLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7b0JBQzlFLFdBQVcsR0FBRyxJQUFJLENBQUM7b0JBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUM7b0JBQzVDLDZFQUE2RTtvQkFDN0UsQ0FBQyxFQUFFLENBQUM7aUJBQ0w7YUFDRjtZQUVELE9BQU8sV0FBVyxDQUFDO1NBQ3BCO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU0sSUFBSSxDQUFDLGtCQUFzQztRQUNoRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDckQsQ0FBQzs7QUFwUWMsaUNBQWUsR0FBRyxDQUFDLENBQUM7OztZQUpwQyxVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs0Q0F3UWMsTUFBTSxTQUFDLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIGlzRGV2TW9kZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBQYWdlU2Nyb2xsQ29uZmlnIH0gZnJvbSAnLi4vdHlwZXMvcGFnZS1zY3JvbGwuY29uZmlnJztcbmltcG9ydCB7IEludGVycnVwdFJlcG9ydGVyLCBQYWdlU2Nyb2xsSW5zdGFuY2UsIFBhZ2VTY3JvbGxPcHRpb25zIH0gZnJvbSAnLi4vcGFnZS1zY3JvbGwtaW5zdGFuY2UnO1xuaW1wb3J0IHsgZGVmYXVsdFBhZ2VTY3JvbGxDb25maWcsIE5HWFBTX0NPTkZJRyB9IGZyb20gJy4vY29uZmlnLnByb3ZpZGVyJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFBhZ2VTY3JvbGxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2VDb3VudGVyID0gMDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogUGFnZVNjcm9sbENvbmZpZztcblxuICBwcml2YXRlIHJ1bm5pbmdJbnN0YW5jZXM6IFBhZ2VTY3JvbGxJbnN0YW5jZVtdID0gW107XG5cbiAgcHJpdmF0ZSBvbkludGVycnVwdGVkOiBJbnRlcnJ1cHRSZXBvcnRlciA9IHtcbiAgICByZXBvcnQ6IChldmVudDogRXZlbnQsIHBhZ2VTY3JvbGxJbnN0YW5jZTogUGFnZVNjcm9sbEluc3RhbmNlKTogdm9pZCA9PiB7XG4gICAgICBpZiAoIXBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5pbnRlcnJ1cHRpYmxlKSB7XG4gICAgICAgIC8vIE5vbi1pbnRlcnJ1cHRpYmxlIGFueXdheSwgc28gZG8gbm90IHN0b3AgYW55dGhpbmdcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsZXQgc2hvdWxkU3RvcCA9IHRydWU7XG5cbiAgICAgIGlmIChldmVudC50eXBlID09PSAna2V5dXAnKSB7XG4gICAgICAgIC8vIE9ubHkgc3RvcCBpZiBzcGVjaWZpYyBrZXlzIGhhdmUgYmVlbiBwcmVzc2VkLCBmb3IgYWxsIG90aGVycyBkb24ndCBzdG9wIGFueXRoaW5nXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5pbnRlcnJ1cHRLZXlzLmluZGV4T2YoKGV2ZW50IGFzIEtleWJvYXJkRXZlbnQpLmtleSkgPT09IC0xKSB7XG4gICAgICAgICAgLy8gVGhlIHByZXNzZWQga2V5IGlzIG5vdCBpbiB0aGUgbGlzdCBvZiBpbnRlcnJ1cHRpbmcga2V5c1xuICAgICAgICAgIHNob3VsZFN0b3AgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSAnbW91c2Vkb3duJykge1xuICAgICAgICAvLyBGb3IgbW91c2Vkb3duIGV2ZW50cyB3ZSBvbmx5IHN0b3AgdGhlIHNjcm9sbCBhbmltYXRpb24gb2YgdGhlIG1vdXNlIGhhc1xuICAgICAgICAvLyBiZWVuIGNsaWNrZWQgaW5zaWRlIHRoZSBzY3JvbGxpbmcgY29udGFpbmVyXG4gICAgICAgIGlmICghcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFZpZXdzLnNvbWUoc2Nyb2xsaW5nVmlldyA9PiBzY3JvbGxpbmdWaWV3LmNvbnRhaW5zKGV2ZW50LnRhcmdldCBhcyBOb2RlKSkpIHtcbiAgICAgICAgICAvLyBNb3VzZSBjbGlja2VkIGFuIGVsZW1lbnQgd2hpY2ggaXMgbm90IGluc2lkZSBhbnkgb2YgdGhlIHRoZSBzY3JvbGxpbmcgY29udGFpbmVyc1xuICAgICAgICAgIHNob3VsZFN0b3AgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoc2hvdWxkU3RvcCkge1xuICAgICAgICB0aGlzLnN0b3BBbGwocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLm5hbWVzcGFjZSk7XG4gICAgICB9XG4gICAgfSxcbiAgfTtcblxuICBwcml2YXRlIHN0b3BJbnRlcm5hbChpbnRlcnJ1cHRlZDogYm9vbGVhbiwgcGFnZVNjcm9sbEluc3RhbmNlOiBQYWdlU2Nyb2xsSW5zdGFuY2UpOiBib29sZWFuIHtcbiAgICBjb25zdCBpbmRleDogbnVtYmVyID0gdGhpcy5ydW5uaW5nSW5zdGFuY2VzLmluZGV4T2YocGFnZVNjcm9sbEluc3RhbmNlKTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgdGhpcy5ydW5uaW5nSW5zdGFuY2VzLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuXG4gICAgaWYgKHBhZ2VTY3JvbGxJbnN0YW5jZS5pbnRlcnJ1cHRMaXN0ZW5lcnNBdHRhY2hlZCkge1xuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmRldGFjaEludGVycnVwdExpc3RlbmVycygpO1xuICAgIH1cblxuICAgIGlmIChwYWdlU2Nyb2xsSW5zdGFuY2UudGltZXIpIHtcbiAgICAgIC8vIENsZWFyL1N0b3AgdGhlIHRpbWVyXG4gICAgICBjbGVhckludGVydmFsKHBhZ2VTY3JvbGxJbnN0YW5jZS50aW1lcik7XG4gICAgICAvLyBDbGVhciB0aGUgcmVmZXJlbmNlIHRvIHRoaXMgdGltZXJcbiAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS50aW1lciA9IHVuZGVmaW5lZDtcbiAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5maXJlRXZlbnQoIWludGVycnVwdGVkKTtcblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZShvcHRpb25zOiBQYWdlU2Nyb2xsT3B0aW9ucyk6IFBhZ2VTY3JvbGxJbnN0YW5jZSB7XG4gICAgcmV0dXJuIG5ldyBQYWdlU2Nyb2xsSW5zdGFuY2Uoey4uLnRoaXMuY29uZmlnLCAuLi5vcHRpb25zfSBhcyBQYWdlU2Nyb2xsT3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgYSBzY3JvbGwgYW5pbWF0aW9uLiBBbGwgcHJvcGVydGllcyBvZiB0aGUgYW5pbWF0aW9uIGFyZSBzdG9yZWQgaW4gdGhlIGdpdmVuIHtAbGluayBQYWdlU2Nyb2xsSW5zdGFuY2V9IG9iamVjdC5cbiAgICpcbiAgICogVGhpcyBpcyB0aGUgY29yZSBmdW5jdGlvbmFsaXR5IG9mIHRoZSB3aG9sZSBsaWJyYXJ5LlxuICAgKi9cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmN5Y2xvbWF0aWMtY29tcGxleGl0eVxuICBwdWJsaWMgc3RhcnQocGFnZVNjcm9sbEluc3RhbmNlOiBQYWdlU2Nyb2xsSW5zdGFuY2UpOiB2b2lkIHtcbiAgICAvLyBNZXJnZSB0aGUgZGVmYXVsdCBvcHRpb25zIGluIHRoZSBwYWdlU2Nyb2xsSW5zdGFuY2Ugb3B0aW9uc1xuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucyA9IHsuLi50aGlzLmNvbmZpZywgLi4ucGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zfSBhcyBQYWdlU2Nyb2xsT3B0aW9ucztcblxuICAgIC8vIFN0b3AgYWxsIHBvc3NpYmx5IHJ1bm5pbmcgc2Nyb2xsIGFuaW1hdGlvbnMgaW4gdGhlIHNhbWUgbmFtZXNwYWNlXG4gICAgdGhpcy5zdG9wQWxsKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5uYW1lc3BhY2UpO1xuXG4gICAgaWYgKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cyA9PT0gbnVsbCB8fCBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuc2Nyb2xsVmlld3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBObyBzY3JvbGxWaWV3cyBzcGVjaWZpZWQsIHRodXMgd2UgY2FuJ3QgYW5pbWF0ZSBhbnl0aGluZ1xuICAgICAgaWYgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAyIHx8ICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMSAmJiBpc0Rldk1vZGUoKSkpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdObyBzY3JvbGxWaWV3cyBzcGVjaWZpZWQsIHRodXMgbmd4LXBhZ2Utc2Nyb2xsIGRvZXMgbm90IGtub3cgd2hpY2ggRE9NIGVsZW1lbnRzIHRvIHNjcm9sbCcpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IHN0YXJ0U2Nyb2xsUG9zaXRpb25Gb3VuZCA9IGZhbHNlO1xuICAgIGxldCBzY3JvbGxSYW5nZSA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5nZXRTY3JvbGxDbGllbnRQcm9wZXJ0eVZhbHVlKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3c1swXSk7XG4gICAgLy8gUmVzZXQgc3RhcnQgc2Nyb2xsIHBvc2l0aW9uIHRvIDAuIElmIGFueSBvZiB0aGUgc2Nyb2xsVmlld3MgaGFzIGEgZGlmZmVyZW50IG9uZSwgaXQgd2lsbCBiZSBleHRyYWN0ZWQgbmV4dFxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5zdGFydFNjcm9sbFBvc2l0aW9uID0gMDtcblxuICAgIC8vIEdldCB0aGUgc3RhcnQgc2Nyb2xsIHBvc2l0aW9uIGZyb20gdGhlIHNjcm9sbFZpZXdzIChlLmcuIGlmIHRoZSB1c2VyIGFscmVhZHkgc2Nyb2xsZWQgZG93biB0aGUgY29udGVudClcbiAgICBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuc2Nyb2xsVmlld3MuZm9yRWFjaChzY3JvbGxpbmdWaWV3ID0+IHtcbiAgICAgIGlmIChzY3JvbGxpbmdWaWV3ID09PSB1bmRlZmluZWQgfHwgc2Nyb2xsaW5nVmlldyA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICAvLyBHZXQgdGhlIHNjcm9sbFRvcCBvciBzY3JvbGxMZWZ0IHZhbHVlIG9mIHRoZSBmaXJzdCBzY3JvbGxpbmdWaWV3IHRoYXQgcmV0dXJucyBhIHZhbHVlIGZvciBpdHMgXCJzY3JvbGxUb3BcIlxuICAgICAgLy8gb3IgXCJzY3JvbGxMZWZ0XCIgcHJvcGVydHkgdGhhdCBpcyBub3QgdW5kZWZpbmVkIGFuZCB1bmVxdWFsIHRvIDBcblxuICAgICAgY29uc3Qgc2Nyb2xsUG9zaXRpb24gPSBwYWdlU2Nyb2xsSW5zdGFuY2UuZ2V0U2Nyb2xsUHJvcGVydHlWYWx1ZShzY3JvbGxpbmdWaWV3KTtcbiAgICAgIGlmICghc3RhcnRTY3JvbGxQb3NpdGlvbkZvdW5kICYmIHNjcm9sbFBvc2l0aW9uKSB7XG4gICAgICAgIC8vIFdlIGZvdW5kIGEgc2Nyb2xsaW5nVmlldyB0aGF0IGRvZXMgbm90IGhhdmUgc2Nyb2xsVG9wIG9yIHNjcm9sbExlZnQgMFxuXG4gICAgICAgIC8vIFJldHVybiB0aGUgc2Nyb2xsIHBvc2l0aW9uIHZhbHVlLCBhcyB0aGlzIHdpbGwgYmUgb3VyIHN0YXJ0U2Nyb2xsUG9zaXRpb25cbiAgICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLnN0YXJ0U2Nyb2xsUG9zaXRpb24gPSBzY3JvbGxQb3NpdGlvbjtcbiAgICAgICAgc3RhcnRTY3JvbGxQb3NpdGlvbkZvdW5kID0gdHJ1ZTtcblxuICAgICAgICAvLyBSZW1lbWJlciB0ZSBzY3JvbGxSYW5nZSBvZiB0aGlzIHNjcm9sbGluZ1ZpZXdcbiAgICAgICAgc2Nyb2xsUmFuZ2UgPSBwYWdlU2Nyb2xsSW5zdGFuY2UuZ2V0U2Nyb2xsQ2xpZW50UHJvcGVydHlWYWx1ZShzY3JvbGxpbmdWaWV3KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHBhZ2VTY3JvbGxPZmZzZXQgPSBwYWdlU2Nyb2xsSW5zdGFuY2UuZ2V0Q3VycmVudE9mZnNldCgpO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHRoZSB0YXJnZXQgcG9zaXRpb24gdGhhdCB0aGUgc2Nyb2xsIGFuaW1hdGlvbiBzaG91bGQgZ28gdG9cblxuICAgIGNvbnN0IHNjcm9sbFRhcmdldFBvc2l0aW9uID0gcGFnZVNjcm9sbEluc3RhbmNlLmV4dHJhY3RTY3JvbGxUYXJnZXRQb3NpdGlvbigpO1xuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS50YXJnZXRTY3JvbGxQb3NpdGlvbiA9IE1hdGgucm91bmQoXG4gICAgICAocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnZlcnRpY2FsU2Nyb2xsaW5nID8gc2Nyb2xsVGFyZ2V0UG9zaXRpb24udG9wIDogc2Nyb2xsVGFyZ2V0UG9zaXRpb24ubGVmdCkgLSBwYWdlU2Nyb2xsT2Zmc2V0KTtcblxuICAgIC8vIENhbGN1bGF0ZSB0aGUgZGlzdGFuY2Ugd2UgbmVlZCB0byBnbyBpbiB0b3RhbFxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5kaXN0YW5jZVRvU2Nyb2xsID0gcGFnZVNjcm9sbEluc3RhbmNlLnRhcmdldFNjcm9sbFBvc2l0aW9uIC0gcGFnZVNjcm9sbEluc3RhbmNlLnN0YXJ0U2Nyb2xsUG9zaXRpb247XG5cbiAgICBpZiAoaXNOYU4ocGFnZVNjcm9sbEluc3RhbmNlLmRpc3RhbmNlVG9TY3JvbGwpKSB7XG4gICAgICAvLyBXZSB3ZXJlbid0IGFibGUgdG8gZmluZCB0aGUgdGFyZ2V0IHBvc2l0aW9uLCBtYXliZSB0aGUgZWxlbWVudCBkb2VzIG5vdCBleGlzdD9cblxuICAgICAgaWYgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAyIHx8ICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMSAmJiBpc0Rldk1vZGUoKSkpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1Njcm9sbGluZyBub3QgcG9zc2libGUsIGFzIHdlIGNhblxcJ3QgZmluZCB0aGUgc3BlY2lmaWVkIHRhcmdldCcpO1xuICAgICAgfVxuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmZpcmVFdmVudChmYWxzZSk7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBXZSdyZSBhdCB0aGUgZmluYWwgZGVzdGluYXRpb24gYWxyZWFkeVxuICAgIC8vIE9SIHdlIG5lZWQgdG8gc2Nyb2xsIGRvd24gYnV0IGFyZSBhbHJlYWR5IGF0IHRoZSBlbmRcbiAgICAvLyBPUiB3ZSBuZWVkIHRvIHNjcm9sbCB1cCBidXQgYXJlIGF0IHRoZSB0b3AgYWxyZWFkeVxuICAgIGNvbnN0IGFsbFJlYWR5QXREZXN0aW5hdGlvbiA9IE1hdGguYWJzKHBhZ2VTY3JvbGxJbnN0YW5jZS5kaXN0YW5jZVRvU2Nyb2xsKSA8IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5fbWluU2Nyb2xsRGlzdGFuY2U7XG5cbiAgICAvLyBDaGVjayBob3cgbG9uZyB3ZSBuZWVkIHRvIHNjcm9sbCBpZiBhIHNwZWVkIG9wdGlvbiBpcyBnaXZlblxuICAgIC8vIERlZmF1bHQgZXhlY3V0aW9uRHVyYXRpb24gaXMgdGhlIHNwZWNpZmllZCBkdXJhdGlvblxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5leGVjdXRpb25EdXJhdGlvbiA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5kdXJhdGlvbjtcbiAgICAvLyBNYXliZSB3ZSBuZWVkIHRvIHBheSBhdHRlbnRpb24gdG8gdGhlIHNwZWVkIG9wdGlvbj9cbiAgICBpZiAoKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zcGVlZCAhPT0gdW5kZWZpbmVkICYmIHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zcGVlZCAhPT0gbnVsbCkgJiZcbiAgICAgIChwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuZHVyYXRpb24gPT09IHVuZGVmaW5lZCB8fCBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuZHVyYXRpb24gPT09IG51bGwpKSB7XG4gICAgICAvLyBTcGVlZCBvcHRpb24gaXMgc2V0IGFuZCBubyBkdXJhdGlvbiA9PiBjYWxjdWxhdGUgZHVyYXRpb24gYmFzZWQgb24gc3BlZWQgYW5kIHNjcm9sbCBkaXN0YW5jZVxuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmV4ZWN1dGlvbkR1cmF0aW9uID1cbiAgICAgICAgTWF0aC5hYnMocGFnZVNjcm9sbEluc3RhbmNlLmRpc3RhbmNlVG9TY3JvbGwpIC8gcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNwZWVkICogMTAwMDtcbiAgICB9XG5cbiAgICAvLyBXZSBzaG91bGQgZ28gdGhlcmUgZGlyZWN0bHksIGFzIG91ciBcImFuaW1hdGlvblwiIHdvdWxkIGhhdmUgb25lIGJpZyBzdGVwXG4gICAgLy8gb25seSBhbnl3YXkgYW5kIHRoaXMgd2F5IHdlIHNhdmUgdGhlIGludGVydmFsIHN0dWZmXG4gICAgY29uc3QgdG9vU2hvcnRJbnRlcnZhbCA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5leGVjdXRpb25EdXJhdGlvbiA8PSBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuX2ludGVydmFsO1xuXG4gICAgaWYgKGFsbFJlYWR5QXREZXN0aW5hdGlvbiB8fCB0b29TaG9ydEludGVydmFsKSB7XG4gICAgICBpZiAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDIgfHwgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAxICYmIGlzRGV2TW9kZSgpKSkge1xuICAgICAgICBpZiAoYWxsUmVhZHlBdERlc3RpbmF0aW9uKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1Njcm9sbGluZyBub3QgcG9zc2libGUsIGFzIHdlIGNhblxcJ3QgZ2V0IGFueSBjbG9zZXIgdG8gdGhlIGRlc3RpbmF0aW9uJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1Njcm9sbCBkdXJhdGlvbiBzaG9ydGVyIHRoYXQgaW50ZXJ2YWwgbGVuZ3RoLCBqdW1waW5nIHRvIHRhcmdldCcpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBwYWdlU2Nyb2xsSW5zdGFuY2Uuc2V0U2Nyb2xsUG9zaXRpb24ocGFnZVNjcm9sbEluc3RhbmNlLnRhcmdldFNjcm9sbFBvc2l0aW9uKTtcbiAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5maXJlRXZlbnQodHJ1ZSk7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxJblZpZXcpIHtcbiAgICAgIGNvbnN0IGFscmVhZHlJblZpZXcgPSBwYWdlU2Nyb2xsSW5zdGFuY2UudGFyZ2V0U2Nyb2xsUG9zaXRpb24gPiBwYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRTY3JvbGxQb3NpdGlvbiAmJlxuICAgICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UudGFyZ2V0U2Nyb2xsUG9zaXRpb24gPD0gcGFnZVNjcm9sbEluc3RhbmNlLnN0YXJ0U2Nyb2xsUG9zaXRpb24gKyBzY3JvbGxSYW5nZTtcbiAgICAgIGlmIChhbHJlYWR5SW5WaWV3KSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMiB8fCAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDEgJiYgaXNEZXZNb2RlKCkpKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ05vdCBzY3JvbGxpbmcsIGFzIHRhcmdldCBhbHJlYWR5IGluIHZpZXcnKTtcbiAgICAgICAgfVxuICAgICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuZmlyZUV2ZW50KHRydWUpO1xuXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZWdpc3RlciB0aGUgaW50ZXJydXB0IGxpc3RlbmVycyBpZiB3ZSB3YW50IGFuIGludGVycnVwdGlibGUgc2Nyb2xsIGFuaW1hdGlvblxuICAgIGlmIChwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuaW50ZXJydXB0aWJsZSkge1xuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmF0dGFjaEludGVycnVwdExpc3RlbmVycyh0aGlzLm9uSW50ZXJydXB0ZWQpO1xuICAgIH1cblxuICAgIC8vIExldCdzIGdldCBzdGFydGVkLCBnZXQgdGhlIHN0YXJ0IHRpbWUuLi5cbiAgICBwYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgLy8gLi4gYW5kIGNhbGN1bGF0ZSB0aGUgZW5kIHRpbWUgKHdoZW4gd2UgbmVlZCB0byBmaW5pc2ggYXQgbGFzdClcbiAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuZW5kVGltZSA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5zdGFydFRpbWUgKyBwYWdlU2Nyb2xsSW5zdGFuY2UuZXhlY3V0aW9uRHVyYXRpb247XG5cbiAgICBwYWdlU2Nyb2xsSW5zdGFuY2UudGltZXIgPSBzZXRJbnRlcnZhbCgoaW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSkgPT4ge1xuICAgICAgLy8gVGFrZSB0aGUgY3VycmVudCB0aW1lXG4gICAgICBjb25zdCBjdXJyZW50VGltZTogbnVtYmVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cbiAgICAgIC8vIERldGVybWluZSB0aGUgbmV3IHNjcm9sbCBwb3NpdGlvblxuICAgICAgbGV0IG5ld1Njcm9sbFBvc2l0aW9uOiBudW1iZXI7XG4gICAgICBsZXQgc3RvcE5vdyA9IGZhbHNlO1xuICAgICAgaWYgKGluc3RhbmNlLmVuZFRpbWUgPD0gY3VycmVudFRpbWUpIHtcbiAgICAgICAgLy8gV2UncmUgb3ZlciB0aGUgdGltZSBhbHJlYWR5LCBzbyBnbyB0aGUgdGFyZ2V0U2Nyb2xsUG9zaXRpb24gKGFrYSBkZXN0aW5hdGlvbilcbiAgICAgICAgbmV3U2Nyb2xsUG9zaXRpb24gPSBpbnN0YW5jZS50YXJnZXRTY3JvbGxQb3NpdGlvbjtcbiAgICAgICAgc3RvcE5vdyA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHNjcm9sbCBwb3NpdGlvbiBiYXNlZCBvbiB0aGUgY3VycmVudCB0aW1lIHVzaW5nIHRoZSBlYXNpbmcgZnVuY3Rpb25cbiAgICAgICAgbmV3U2Nyb2xsUG9zaXRpb24gPSBNYXRoLnJvdW5kKGluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLmVhc2luZ0xvZ2ljKFxuICAgICAgICAgIGN1cnJlbnRUaW1lIC0gaW5zdGFuY2Uuc3RhcnRUaW1lLFxuICAgICAgICAgIGluc3RhbmNlLnN0YXJ0U2Nyb2xsUG9zaXRpb24sXG4gICAgICAgICAgaW5zdGFuY2UuZGlzdGFuY2VUb1Njcm9sbCxcbiAgICAgICAgICBpbnN0YW5jZS5leGVjdXRpb25EdXJhdGlvbikpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSA1ICYmIGlzRGV2TW9kZSgpKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignU2Nyb2xsIFBvc2l0aW9uOiAnICsgbmV3U2Nyb2xsUG9zaXRpb24pO1xuICAgICAgfVxuICAgICAgLy8gU2V0IHRoZSBuZXcgc2Nyb2xsUG9zaXRpb24gdG8gYWxsIHNjcm9sbFZpZXdzIGVsZW1lbnRzXG4gICAgICBpZiAoIWluc3RhbmNlLnNldFNjcm9sbFBvc2l0aW9uKG5ld1Njcm9sbFBvc2l0aW9uKSkge1xuICAgICAgICAvLyBTZXR0aW5nIHRoZSBuZXcgc2Nyb2xsVG9wL3Njcm9sbExlZnQgdmFsdWUgZmFpbGVkIGZvciBhbGwgU2Nyb2xsVmlld3NcbiAgICAgICAgLy8gZWFybHkgc3RvcCB0aGUgc2Nyb2xsIGFuaW1hdGlvbiB0byBzYXZlIHJlc291cmNlc1xuICAgICAgICBzdG9wTm93ID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gQXQgdGhlIGVuZCBkbyB0aGUgaW50ZXJuYWwgc3RvcCBtYWludGVuYW5jZSBhbmQgZmlyZSB0aGUgcGFnZVNjcm9sbEZpbmlzaCBldmVudFxuICAgICAgLy8gKG90aGVyd2lzZSB0aGUgZXZlbnQgbWlnaHQgYXJyaXZlIGF0IFwidG9vIGVhcmx5XCIpXG4gICAgICBpZiAoc3RvcE5vdykge1xuICAgICAgICB0aGlzLnN0b3BJbnRlcm5hbChmYWxzZSwgaW5zdGFuY2UpO1xuICAgICAgfVxuXG4gICAgfSwgdGhpcy5jb25maWcuX2ludGVydmFsLCBwYWdlU2Nyb2xsSW5zdGFuY2UpO1xuXG4gICAgLy8gUmVnaXN0ZXIgdGhlIGluc3RhbmNlIGFzIHJ1bm5pbmcgb25lXG4gICAgdGhpcy5ydW5uaW5nSW5zdGFuY2VzLnB1c2gocGFnZVNjcm9sbEluc3RhbmNlKTtcbiAgfVxuXG4gIHB1YmxpYyBzY3JvbGwob3B0aW9uczogUGFnZVNjcm9sbE9wdGlvbnMpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXJ0KHRoaXMuY3JlYXRlKG9wdGlvbnMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wIGFsbCBydW5uaW5nIHNjcm9sbCBhbmltYXRpb25zLiBPcHRpb25hbGx5IGxpbWl0IHRvIHN0b3Agb25seSB0aGUgb25lcyBvZiBzcGVjaWZpYyBuYW1lc3BhY2UuXG4gICAqL1xuICBwdWJsaWMgc3RvcEFsbChuYW1lc3BhY2U/OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5ydW5uaW5nSW5zdGFuY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgIGxldCBzdG9wcGVkU29tZSA9IGZhbHNlO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucnVubmluZ0luc3RhbmNlcy5sZW5ndGg7ICsraSkge1xuICAgICAgICBjb25zdCBwYWdlU2Nyb2xsSW5zdGFuY2UgPSB0aGlzLnJ1bm5pbmdJbnN0YW5jZXNbaV07XG4gICAgICAgIGlmICghbmFtZXNwYWNlIHx8IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSkge1xuICAgICAgICAgIHN0b3BwZWRTb21lID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnN0b3BJbnRlcm5hbCh0cnVlLCBwYWdlU2Nyb2xsSW5zdGFuY2UpO1xuICAgICAgICAgIC8vIERlY3JlYXNlIHRoZSBjb3VudGVyLCBhcyB3ZSByZW1vdmVkIGFuIGl0ZW0gZnJvbSB0aGUgYXJyYXkgd2UgaXRlcmF0ZSBvdmVyXG4gICAgICAgICAgaS0tO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzdG9wcGVkU29tZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgc3RvcChwYWdlU2Nyb2xsSW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnN0b3BJbnRlcm5hbCh0cnVlLCBwYWdlU2Nyb2xsSW5zdGFuY2UpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoQEluamVjdChOR1hQU19DT05GSUcpIGN1c3RvbUNvbmZpZzogUGFnZVNjcm9sbENvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gey4uLmRlZmF1bHRQYWdlU2Nyb2xsQ29uZmlnLCAuLi5jdXN0b21Db25maWd9O1xuXG4gICAgaWYgKFBhZ2VTY3JvbGxTZXJ2aWNlLmluc3RhbmNlQ291bnRlciA+IDAgJiZcbiAgICAgICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMiB8fCAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDEgJiYgaXNEZXZNb2RlKCkpKSkge1xuICAgICAgY29uc29sZS53YXJuKCdBbiBpbnN0YW5jZSBvZiBQYWdlU2Nyb2xsU2VydmljZSBhbHJlYWR5IGV4aXN0cywgdXN1YWxseSAnICtcbiAgICAgICAgJ2luY2x1ZGluZyBvbmUgcHJvdmlkZXIgc2hvdWxkIGJlIGVub3VnaCwgc28gZG91YmxlIGNoZWNrLicpO1xuICAgIH1cbiAgICBQYWdlU2Nyb2xsU2VydmljZS5pbnN0YW5jZUNvdW50ZXIrKztcbiAgfVxufVxuIl19